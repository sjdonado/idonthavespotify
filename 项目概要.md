# IDHS (I Don't Have Spotify) 技术概要

## 项目概述

IDHS 是一个跨平台音乐流媒体链接转换服务，允许用户将来自一个流媒体平台的音乐链接转换为其他平台上的对应链接。用户只需粘贴一个音乐链接，系统会自动搜索并显示该曲目在所有支持的平台上的链接。

**当前版本**: 1.7.3

## 技术栈

### 核心运行时与语言

- **运行时**: Bun 1.x (高性能 JavaScript 运行时)
- **编程语言**: TypeScript 5.9+
- **模块系统**: ESM (ES Modules)

### 前端技术

- **SSR 框架**: Nano-JSX 0.2.0 (轻量级 JSX 框架)
- **样式框架**: Tailwind CSS 4.1
- **交互框架**: Stimulus 3.2.2 (渐进式增强)
- **音频播放**: Howler.js 2.2.4
- **通知系统**: Notyf 3.10.0

### 后端技术

- **HTTP 服务器**: Bun 内置 `serve` API
- **日志系统**: Pino 10.1.0 + Pino-Pretty
- **HTTP 客户端**: Axios 1.7.9 + Axios-Retry
- **HTML 解析**: Cheerio 1.0.0
- **数据验证**: Zod 4.1.12
- **字符串相似度**: String-Similarity 4.0.4
- **分析统计**: Umami Node SDK 0.4.0

### 开发工具

- **构建工具**: Bun Build (内置)
- **代码检查**: ESLint 9.32.0 + TypeScript ESLint
- **代码格式化**: Prettier 3.2.5
- **测试框架**: Bun Test (内置)
- **包管理**: Yarn 4.9.2 / Bun

### 部署与容器化

- **容器化**: Docker + Docker Compose
- **基础镜像**: Alpine Linux 3.20
- **构建镜像**: oven/bun:1-alpine
- **URL 短链服务**: Bit (通过 Docker Compose)

## 项目架构

### 目录结构

```text
src/
├── adapters/          # 平台适配器（搜索目标平台）
│   ├── apple-music.ts
│   ├── deezer.ts
│   ├── sound-cloud.ts
│   ├── spotify.ts
│   ├── tidal.ts
│   └── youtube.ts
├── parsers/           # 链接解析器（解析输入链接）
│   ├── apple-music.ts
│   ├── deezer.ts
│   ├── google.ts
│   ├── link.ts
│   ├── sound-cloud.ts
│   ├── spotify.ts
│   ├── tidal-universal-link.ts
│   ├── tidal.ts
│   └── youtube.ts
├── services/          # 核心服务层
│   ├── cache.ts       # 缓存服务
│   ├── metadata.ts    # 元数据服务
│   ├── search.ts      # 搜索服务（核心）
│   └── umami.ts       # 分析服务
├── config/            # 配置文件
│   ├── constants.ts
│   ├── enum.ts        # 枚举定义
│   ├── env.ts         # 环境变量
│   └── rate-limit.ts  # 速率限制配置
├── schemas/           # Zod 数据验证模式
│   ├── api.schema.ts
│   └── web.schema.ts
├── utils/             # 工具函数
│   ├── access-token.ts
│   ├── compare.ts
│   ├── encoding.ts
│   ├── http-client.ts
│   ├── logger.ts
│   ├── rate-limit-middleware.ts
│   ├── scraper.ts
│   ├── url-shortener.ts
│   └── zod.ts
├── views/             # 视图层（SSR）
│   ├── components/    # React 组件
│   ├── controllers/   # Stimulus 控制器
│   ├── css/           # 样式文件
│   ├── layouts/       # 布局组件
│   └── pages/         # 页面组件
└── index.ts           # 应用入口
```

### 核心架构模式

#### 1. Parser（解析器）模式

- **职责**: 识别输入链接的平台，提取标准化元数据
- **功能**:
  - 解析链接格式（Spotify, YouTube, Apple Music 等）
  - 提取元数据（标题、描述、类型、图片、音频）
  - 生成标准化搜索查询字符串
- **位置**: `src/parsers/`

#### 2. Adapter（适配器）模式

- **职责**: 将标准化查询转换为目标平台的链接
- **功能**:
  - 执行平台特定搜索（API 或 HTML 爬取）
  - 返回结果链接（包含验证状态）
  - 支持 "verified" 链接标记
- **位置**: `src/adapters/`

#### 3. 服务层架构

- **Search Service**: 核心搜索逻辑，协调 Parser 和 Adapter
- **Cache Service**: 缓存搜索结果，提升性能
- **Metadata Service**: 元数据获取和增强
- **Umami Service**: 用户行为分析

## 核心功能

### 支持的流媒体平台

| 平台 | 反向搜索 | 官方 API | 已验证链接 |
|------|---------|---------|-----------|
| Spotify | ✅ | ✅ | ✅ |
| Tidal | ✅ | ✅ | ✅ |
| YouTube Music | ✅ | ❌ | ✅ |
| Apple Music | ✅ | ❌ | ✅ |
| Deezer | ✅ | ✅ | ✅ |
| SoundCloud | ✅ | ❌ | ✅ |

### 支持的内容类型

- 单曲 (Song)
- 专辑 (Album)
- 艺术家 (Artist)
- 播客 (Podcast)
- 节目 (Show)
- ⚠️ 播放列表 (Playlist) - 暂不支持

### API 端点

#### POST `/api/search`

- **功能**: 转换音乐链接
- **参数**:
  - `link`: 音乐链接（必需）
  - `adapters`: 目标平台数组（可选）
- **速率限制**: 10 请求/分钟/IP

#### GET `/api/status`

- **功能**: 查询速率限制状态
- **返回**: IP 地址、速率限制信息、存储大小

#### POST `/search`

- **功能**: Web 界面搜索（返回 HTML）

#### GET `/`

- **功能**: 主页（支持通过 `?id=` 查询参数显示结果）

## 技术特性

### 1. 服务端渲染 (SSR)

- 使用 Nano-JSX 进行服务端渲染
- 支持 SEO 优化（Helmet 集成）
- 首屏快速加载

### 2. 速率限制

- 基于 IP 的速率限制
- Web 和 API 分别限制
- 使用内存存储（可扩展为 Redis）
- 返回标准 HTTP 速率限制头

### 3. 错误处理

- 统一的错误响应格式
- 详细的日志记录（Pino）
- 用户友好的错误消息

### 4. 数据验证

- 使用 Zod 进行请求验证
- 类型安全的 API 接口
- 自动错误格式化

### 5. 构建系统

- **开发模式**: 热重载（Watch Mode）
  - CSS: Tailwind CLI Watch
  - JS: Bun Build Watch
- **生产模式**:
  - CSS: Tailwind 压缩
  - JS: Bun Build 编译为二进制可执行文件
  - 资源优化和压缩

### 6. 测试

- 集成测试 (`api.integration.test.ts`, `page.integration.test.ts`)
- 单元测试 (`parsers/`, `search.test.ts`)
- Mock 数据支持 (`tests/mocks/`)

## 环境变量配置

### 必需配置

- `SPOTIFY_CLIENT_ID` / `SPOTIFY_CLIENT_SECRET`: Spotify Web API
- `TIDAL_CLIENT_ID` / `TIDAL_CLIENT_SECRET`: Tidal Developer API
- `YOUTUBE_API_KEY`: Google Developers Console

### 可选配置

- `API_AUTH_KEY`: API 认证密钥（设置后启用 Bearer Token 认证）
- `URL_SHORTENER_API_KEY`: URL 短链服务 API 密钥
- `PORT`: 服务端口（默认: 3000）
- `NODE_ENV`: 环境模式（development/production/test）

## 部署

### Docker 部署

```bash
docker compose up -d
```

### 本地开发

```bash
bun install
bun dev  # 启动开发服务器（热重载）
```

### 生产构建

```bash
bun run build        # 构建前端资源
bun run build:prod   # 编译为二进制可执行文件
```

## 性能优化

1. **并行搜索**: 使用 `Promise.all` 并行查询多个平台
2. **缓存机制**: 缓存搜索结果，减少重复请求
3. **早期返回**: 当只有一个适配器时提前返回
4. **二进制编译**: 生产环境编译为单一二进制文件，启动快速
5. **资源压缩**: CSS/JS 生产环境压缩

## 安全特性

1. **路径遍历防护**: 严格验证静态文件路径
2. **速率限制**: 防止 API 滥用
3. **API 认证**: 可选的 Bearer Token 认证机制 (通过 `API_AUTH_KEY` 环境变量启用)
4. **输入验证**: Zod Schema 验证所有输入
5. **错误信息**: 生产环境隐藏敏感错误信息

## 扩展性

### 添加新平台

1. 在 `src/parsers/` 添加解析器
2. 在 `src/adapters/` 添加适配器
3. 更新 `src/config/enum.ts` 枚举
4. 在 `src/services/search.ts` 注册新平台

### 扩展功能

- 模块化设计，易于扩展
- 清晰的关注点分离（Parser/Adapter）
- 类型安全的 TypeScript 代码

## 开发工作流

1. **代码检查**: `bun run lint`
2. **类型检查**: `bun run typecheck`
3. **运行测试**: `bun test`
4. **CI 测试**: `bun run test:ci` (包含 Mock 数据获取)

## 项目亮点

1. **高性能**: 基于 Bun 运行时，启动快速，执行高效
2. **类型安全**: 完整的 TypeScript 类型系统
3. **现代化**: 使用最新的 Web 技术和最佳实践
4. **可维护性**: 清晰的架构和代码组织
5. **可扩展性**: 易于添加新平台和功能
6. **用户体验**: SSR + 渐进式增强，快速响应

## 相关资源

- **Web App**: <https://idonthavespotify.sjdonado.com>
- **API 文档**: 见 `API.md`
- **Raycast 扩展**: <https://www.raycast.com/sjdonado/idonthavespotify>
- **Martillo 扩展**: 见 `extra/martillo/`
